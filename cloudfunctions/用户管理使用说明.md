# 用户管理系统使用说明

## 📊 功能概述

现在登录系统已支持保存用户信息到云端，包括：
- 用户昵称
- 用户头像
- 手机号（可选）
- 登录时间
- OpenID（用于识别用户）

## 🚀 部署步骤

### 1. 上传云函数

使用命令上传新创建的云函数：

```powershell
# 进入项目目录
cd d:\wxapp\sleep_point\sleep_point

# 上传云函数
.\copy-cloudfunctions.ps1
```

或者在微信开发者工具中：
1. 右键点击 `cloudfunctions/saveUserInfo` → 上传并部署：云端安装依赖
2. 右键点击 `cloudfunctions/getUserList` → 上传并部署：云端安装依赖

### 2. 创建数据库集合

在微信云开发控制台创建 `users` 集合：

1. 打开微信开发者工具
2. 点击顶部的"云开发"按钮
3. 进入"数据库"标签
4. 点击"添加集合"
5. 集合名称：`users`
6. 权限设置：建议设为"仅创建者可读写"

**数据结构：**
```json
{
  "_id": "自动生成",
  "_openid": "用户OpenID（自动）",
  "nickName": "用户昵称",
  "avatarUrl": "头像URL",
  "phoneNumber": "手机号code（加密）",
  "createdAt": "创建时间",
  "lastLoginTime": "最后登录时间",
  "updatedAt": "更新时间",
  "totalCheckins": 0,
  "totalAchievements": 0
}
```

## 👀 查看用户列表

### 方法1：云开发控制台（推荐）

1. 打开微信开发者工具
2. 点击"云开发"
3. 进入"数据库"
4. 选择 `users` 集合
5. 即可看到所有登录用户的信息

### 方法2：云函数调用

在微信开发者工具的控制台中执行：

```javascript
wx.cloud.callFunction({
  name: 'getUserList',
  data: {
    page: 1,
    pageSize: 20
  }
}).then(res => {
  console.log('用户列表:', res.result.data);
});
```

## 📱 手机号说明

**重要：** 获取手机号功能需要满足以下条件：

1. **小程序已认证**（个人小程序不支持）
2. **用户主动点击按钮授权**
3. 获取到的是加密的 `code`，需要后端解密

**存储的是什么？**
- 当前版本存储的是 `code` 字符串
- 如需获取真实手机号，需要调用微信接口解密（需要后端支持）

**解密方案（可选实现）：**
```javascript
// 在云函数中调用
const result = await cloud.openapi.phonenumber.getPhoneNumber({
  code: phoneCode
});
const phoneNumber = result.phoneInfo.phoneNumber;
```

## 🔍 用户数据统计

可以在云开发控制台看到：
- **总用户数**：`users` 集合的记录数
- **活跃用户**：按 `lastLoginTime` 排序
- **新用户**：按 `createdAt` 排序
- **打卡数据**：与 `checkins` 集合关联查询

## 🔒 隐私与安全

- OpenID 由微信自动生成，不同小程序的同一用户有不同 OpenID
- 手机号 code 加密存储，安全性高
- 数据仅开发者可见，用户无法看到其他用户信息
- 符合微信小程序隐私政策要求

## 📈 扩展功能建议

1. **用户画像分析**
   - 统计用户的打卡频率
   - 分析用户的睡眠心情分布
   - 计算用户活跃度

2. **数据导出**
   - 导出用户列表为 Excel
   - 生成统计报表

3. **推送消息**
   - 向活跃用户发送订阅消息
   - 提醒用户打卡

## ⚠️ 注意事项

1. 云函数调用有配额限制，注意控制调用频率
2. 定期备份数据库数据
3. 手机号功能需要小程序认证后才能使用
4. 遵守《网络安全法》和微信平台规范，保护用户隐私
