# 订阅消息配置指南

## 1. 申请订阅消息模板

### 步骤：

1. **登录微信公众平台**
   - 访问 https://mp.weixin.qq.com
   - 使用小程序管理员账号登录

2. **进入订阅消息管理**
   - 左侧菜单：功能 → 订阅消息
   - 点击「选用」或「申请模板」

3. **选择合适的模板**
   
   推荐模板类型：**健康提醒** 或 **待办提醒**
   
   **参考模板内容**：
   ```
   标题：睡眠提醒
   
   {{thing1.DATA}} - 提醒内容
   {{time2.DATA}} - 提醒时间
   {{thing3.DATA}} - 温馨提示
   ```

4. **获取模板 ID**
   - 模板申请通过后，会显示模板 ID
   - 格式类似：`xxxxxxxxxxxxxxxxxxxxxxxxxxx`
   - 复制模板 ID

5. **配置到项目中**
   
   打开 `utils/cloud/config.js`，填入模板 ID：
   ```javascript
   subscribeMessageTemplateId: '你的模板ID'
   ```

---

## 2. 订阅消息使用流程

### 在设置页面请求权限

用户开启提醒时，调用：

```javascript
import { requestSubscribeMessage } from '@/utils/subscribe.js';
import { CLOUD_CONFIG } from '@/utils/cloud/config.js';

// 请求订阅权限
const granted = await requestSubscribeMessage(
  CLOUD_CONFIG.subscribeMessageTemplateId
);

if (granted) {
  // 用户同意，可以发送消息
  console.log('已获得订阅消息权限');
}
```

### 发送订阅消息

通过云函数发送：

```javascript
// 数据格式示例
const messageData = {
  thing1: {
    value: '该睡觉啦～'
  },
  time2: {
    value: '22:00'
  },
  thing3: {
    value: '早睡早起身体好'
  }
};

// 调用云函数发送
wx.cloud.callFunction({
  name: 'sendMessage',
  data: {
    openid: 'user-openid',
    templateId: 'template-id',
    data: messageData,
    page: 'pages/index/index'
  }
});
```

---

## 3. 实现定时提醒

### 方案一：云函数定时触发器

1. **创建定时云函数**

```javascript
// cloudfunctions/scheduledReminder/index.js
const cloud = require('wx-server-sdk');
cloud.init();
const db = cloud.database();

exports.main = async (event, context) => {
  // 获取当前时间
  const now = new Date();
  const hour = now.getHours();
  const minute = now.getMinutes();
  const currentTime = `${hour}:${minute}`;
  
  // 查询所有启用了提醒的用户
  const users = await db.collection('users')
    .where({
      'settings.reminderEnabled': true,
      'settings.reminderTime': currentTime
    })
    .get();
  
  // 给每个用户发送消息
  for (const user of users.data) {
    try {
      await cloud.openapi.subscribeMessage.send({
        touser: user._openid,
        templateId: 'your-template-id',
        page: 'pages/index/index',
        data: {
          thing1: { value: '该睡觉啦～' },
          time2: { value: currentTime },
          thing3: { value: '早睡早起身体好' }
        }
      });
    } catch (err) {
      console.error('发送失败:', err);
    }
  }
};
```

2. **配置触发器**

在云函数目录创建 `config.json`：

```json
{
  "triggers": [
    {
      "name": "everyMinute",
      "type": "timer",
      "config": "0 * * * * * *"
    }
  ]
}
```

### 方案二：使用小程序后台定时任务

> 注意：需要企业主体小程序

---

## 4. 注意事项

### 订阅消息限制

1. **次数限制**
   - 用户每授权一次，只能发送一条消息
   - 需要在每次打卡后重新请求授权

2. **内容限制**
   - 模板内容不可随意修改
   - 必须符合微信规范

3. **时间限制**
   - 消息有效期一般为 7 天
   - 超时未发送则失效

### 最佳实践

1. **授权时机**
   - 在用户开启提醒开关时请求
   - 打卡成功后提示「明日继续」时请求

2. **用户体验**
   - 不要频繁打扰用户
   - 提供关闭提醒的选项
   - 消息内容友好温馨

3. **降级方案**
   - 用户拒绝授权时，使用本地通知（仅前台）
   - 提供手动设置闹钟的引导

---

## 5. 测试订阅消息

### 开发环境测试

```javascript
// 在设置页面测试
async testSubscribe() {
  const templateId = CLOUD_CONFIG.subscribeMessageTemplateId;
  
  if (!templateId) {
    uni.showToast({
      title: '请先配置模板ID',
      icon: 'none'
    });
    return;
  }
  
  const granted = await requestSubscribeMessage(templateId);
  
  if (granted) {
    uni.showToast({
      title: '授权成功',
      icon: 'success'
    });
  } else {
    uni.showToast({
      title: '授权失败',
      icon: 'none'
    });
  }
}
```

---

## 6. 相关文档

- [订阅消息开发指南](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message.html)
- [订阅消息API文档](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/subscribe-message/wx.requestSubscribeMessage.html)
- [云开发定时触发器](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/triggers.html)

---

**创建时间**: 2026-01-24  
**版本**: v1.3.0
